# AI旅行规划软件设计文档

## 1. 项目概述

### 1.1 项目简介
AI旅行规划软件是一个基于大语言模型（LLM）的智能旅行助手，旨在帮助用户快速生成个性化的旅行计划。系统集成了行程规划、预算管理、地图可视化、用户偏好管理等功能，支持多地图服务商和云端数据同步。

### 1.2 项目目标
- 提供智能化的旅行计划生成服务
- 支持多维度输入（目的地、天数、预算、偏好等）
- 实现费用管理和AI分析
- 提供地图可视化和路线规划
- 支持云端数据同步和本地存储双模式

### 1.3 技术栈
**前端技术栈：**
- React 18 - UI框架
- Vite - 构建工具
- React Router - 路由管理
- Web Speech API - 语音输入
- Leaflet / 高德地图 / 百度地图 SDK - 地图可视化
- React Markdown - Markdown渲染
- Supabase JS SDK - 云端数据同步

**后端技术栈：**
- Spring Boot 3 - 后端框架
- Java 17+ - 开发语言
- RestTemplate / Apache HttpClient5 - HTTP客户端
- Maven - 依赖管理

**部署技术栈：**
- Docker / Docker Compose - 容器化部署
- Nginx - 反向代理和静态文件服务
- Supabase (PostgreSQL) - 云端数据库

## 2. 系统架构

### 2.1 整体架构
系统采用前后端分离架构，通过RESTful API进行通信。

```
┌─────────────────┐
│   用户浏览器     │
│  (React前端)     │
└────────┬────────┘
         │ HTTP/HTTPS
         │
┌────────▼────────┐
│   Nginx反向代理  │
│  (端口80/8080)   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌──▼──────┐
│前端静态│ │后端API  │
│文件服务│ │(8081)   │
└───────┘ └────┬───┘
                │
         ┌──────▼──────┐
         │  外部服务   │
         │ - LLM API  │
         │ - 地图服务 │
         │ - Supabase │
         └────────────┘
```

### 2.2 前端架构
前端采用单页应用（SPA）架构，主要模块包括：

- **页面组件** (`src/pages/`)
  - Planner.jsx - 行程规划页面
  - Budget.jsx - 预算管理页面
  - Settings.jsx - 配置管理页面
  - Login.jsx - 登录页面
  - Profile.jsx - 用户资料页面

- **共享组件** (`src/shared/`)
  - MapView.jsx - 地图可视化组件
  - VoiceInput.jsx - 语音输入组件
  - MarkdownPreview.jsx - Markdown预览组件

- **服务层** (`src/services/`)
  - llm.js - LLM服务调用
  - geocode.js - 地理编码和路线规划
  - supabase.js - Supabase数据访问
  - plans.js - 行程数据管理
  - config.js - 配置管理
  - inputParser.js - 自然语言解析
  - routeParser.js - 路线解析

### 2.3 后端架构
后端采用Spring Boot框架，提供统一的API代理服务：

- **控制器层**
  - ApiController.java - LLM API代理控制器

- **核心功能**
  - LLM请求代理和重试机制
  - 超时控制（连接10秒，读取120秒）
  - 错误处理和内容审查处理

### 2.4 数据存储架构
系统支持双模式数据存储：

1. **本地存储模式**
   - 使用浏览器 `localStorage` 和 `sessionStorage`
   - 适用于演示和离线场景
   - 数据仅保存在客户端

2. **云端存储模式**
   - 使用 Supabase (PostgreSQL)
   - 支持用户认证和数据同步
   - 数据持久化到云端

## 3. 核心功能模块

### 3.1 智能行程规划模块

#### 3.1.1 功能描述
根据用户输入的目的地、天数、预算、同行人数、旅行偏好等信息，调用大语言模型生成详细的逐日旅行计划。

#### 3.1.2 核心功能
- **多维度输入**
  - 目的地（必填）
  - 旅行天数
  - 预算金额
  - 同行人数
  - 旅行偏好（美食、自然、历史、艺术、亲子、动漫、购物）
  - 出发日期
  - 其他备注

- **语音输入支持**
  - 使用 Web Speech API 实现语音转文字
  - 自动添加标点符号
  - 支持自然语言解析

- **智能解析**
  - 使用LLM解析自然语言输入
  - 自动提取结构化信息
  - 偏好关键词映射

- **行程生成**
  - 调用LLM生成Markdown格式的行程
  - 包含逐日安排、交通、住宿、景点、餐饮
  - 费用估算

- **行程管理**
  - 保存行程到云端或本地
  - 草稿自动保存
  - 行程列表查看和删除
  - 偏好同步

#### 3.1.3 技术实现
- 前端：`src/pages/Planner.jsx`
- 服务：`src/services/llm.js`, `src/services/inputParser.js`, `src/services/plans.js`
- 后端：`/api/llm/chat` 接口

### 3.2 费用管理与AI分析模块

#### 3.2.1 功能描述
记录旅行过程中的各项费用，进行分类统计，并提供AI分析功能，生成支出结构总结和优化建议。

#### 3.2.2 核心功能
- **费用记录**
  - 每日费用录入
  - 分类管理（交通、住宿、餐饮、购物、娱乐等）
  - 支持语音输入快速生成账目

- **预算管理**
  - 总预算设置
  - 实时余额计算
  - 超支提醒

- **统计分析**
  - 分类统计图表
  - 支出趋势分析
  - 预算使用率

- **AI分析**
  - 调用LLM分析支出结构
  - 生成优化建议
  - 支出合理性评估

- **云端同步**
  - 保存历史预算记录
  - 最后同步时间显示
  - 支持反复加载

#### 3.2.3 技术实现
- 前端：`src/pages/Budget.jsx`
- 服务：`src/services/llm.js`, `src/services/plans.js`

### 3.3 地图可视化与导航模块

#### 3.3.1 功能描述
在地图上可视化显示旅行计划中的地点，支持路线规划和多种地图服务商。

#### 3.3.2 核心功能
- **多地图支持**
  - 高德地图（中国境内推荐）
  - 百度地图（中国境内推荐）
  - OpenStreetMap（全球，无需Key）

- **地点可视化**
  - 自动解析行程中的地点
  - 批量地理编码
  - 彩色标记显示
  - 行政区过滤

- **路线规划**
  - 驾车路线
  - 步行路线
  - 公交路线
  - 途经点支持

- **地图功能**
  - 地图状态持久化
  - 地图快照缓存
  - 失败回退策略
  - 动态SDK加载

#### 3.3.3 技术实现
- 前端：`src/shared/MapView.jsx`
- 服务：`src/services/geocode.js`, `src/services/routeParser.js`, `src/services/boundary.js`

### 3.4 用户体系与资料管理模块

#### 3.4.1 功能描述
提供用户认证、资料管理和偏好设置功能，支持本地模拟和Supabase真实认证双模式。

#### 3.4.2 核心功能
- **用户认证**
  - 邮箱注册
  - 密码登录
  - 本地模拟登录（演示模式）
  - Supabase真实认证（生产模式）
  - 会话管理

- **用户资料**
  - 基本信息管理
  - 登录时间记录
  - 云端同步

- **偏好管理**
  - 偏好分类设置
  - 自定义偏好标签
  - 偏好云端同步
  - 偏好导入/导出

#### 3.4.3 技术实现
- 前端：`src/pages/Login.jsx`, `src/pages/Profile.jsx`
- 服务：`src/services/supabase.js`, `src/services/plans.js`

### 3.5 配置管理模块

#### 3.5.1 功能描述
统一管理系统的运行时配置，包括LLM配置、地图配置、Supabase配置等。

#### 3.5.2 核心功能
- **LLM配置**
  - Base URL（兼容OpenAI格式）
  - API Key
  - 模型名称

- **地图配置**
  - 地图服务商选择
  - API Key配置
  - 路线策略设置

- **Supabase配置**
  - URL配置
  - Anon Key
  - Service Role Key（可选）

- **其他配置**
  - 预算币种
  - 主题设置

- **配置管理**
  - 配置导入/导出
  - 配置重置
  - 云端配置保存
  - 配置验证

#### 3.5.3 技术实现
- 前端：`src/pages/Settings.jsx`
- 服务：`src/services/config.js`, `src/services/configLoader.js`

## 4. 数据库设计

### 4.1 数据库选型
系统使用 Supabase (PostgreSQL) 作为云端数据库，同时支持本地存储模式。

### 4.2 数据表设计

#### 4.2.1 travel_plans（旅行计划表）
存储用户的旅行计划信息。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | UUID | 主键 | PRIMARY KEY |
| user_id | UUID | 用户ID | FOREIGN KEY, NOT NULL |
| destination | VARCHAR(255) | 目的地 | NOT NULL |
| days | INTEGER | 旅行天数 | |
| budget | DECIMAL(10,2) | 预算金额 | |
| people | INTEGER | 同行人数 | |
| preferences | TEXT | 旅行偏好（JSON格式） | |
| start_date | DATE | 出发日期 | |
| plan_content | TEXT | 计划内容（Markdown） | |
| input_text | TEXT | 原始输入文本 | |
| notes | TEXT | 备注信息 | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT NOW() |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT NOW() |

**索引：**
- `idx_travel_plans_user_id` ON `user_id`
- `idx_travel_plans_created_at` ON `created_at`

#### 4.2.2 user_profiles（用户资料表）
存储用户的基本信息。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | UUID | 主键 | PRIMARY KEY |
| user_id | UUID | 用户ID（关联Supabase Auth） | UNIQUE, NOT NULL |
| name | VARCHAR(255) | 用户名称 | |
| email | VARCHAR(255) | 邮箱 | |
| login_time | TIMESTAMP | 最后登录时间 | |

**索引：**
- `idx_user_profiles_user_id` ON `user_id`

#### 4.2.3 user_preferences（用户偏好表）
存储用户的旅行偏好设置。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | UUID | 主键 | PRIMARY KEY |
| user_id | UUID | 用户ID | FOREIGN KEY, UNIQUE, NOT NULL |
| preferences | TEXT | 偏好设置（JSON格式） | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT NOW() |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT NOW() |

**索引：**
- `idx_user_preferences_user_id` ON `user_id`

#### 4.2.4 budget_records（预算记录表）
存储用户的费用记录。

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | UUID | 主键 | PRIMARY KEY |
| user_id | UUID | 用户ID | FOREIGN KEY, NOT NULL |
| entries | TEXT | 费用条目（JSON格式） | |
| total_budget | DECIMAL(10,2) | 总预算 | |
| analysis_result | TEXT | AI分析结果 | |
| created_at | TIMESTAMP | 创建时间 | DEFAULT NOW() |
| updated_at | TIMESTAMP | 更新时间 | DEFAULT NOW() |

**索引：**
- `idx_budget_records_user_id` ON `user_id`

### 4.3 数据关系图
```
user_profiles (1) ──┐
                     │
user_preferences (1) ├── (N) user_id (FOREIGN KEY)
                     │
travel_plans (N) ────┘
budget_records (N) ──┘
```

### 4.4 本地存储结构
当未配置Supabase时，系统使用浏览器localStorage模拟数据库：

- `supabase_users` - 用户列表（JSON数组）
- `supabase_plans` - 旅行计划（JSON数组）
- `supabase_profiles` - 用户资料（JSON数组）
- `supabase_preferences` - 用户偏好（JSON数组）
- `supabase_budget_records` - 预算记录（JSON数组）
- `runtime_config_v1` - 运行时配置（JSON对象）
- `supabase_session` - 会话信息（JSON对象）

## 5. API设计

### 5.1 后端API

#### 5.1.1 LLM聊天接口
**接口地址：** `POST /api/llm/chat`

**请求头：**
```
Content-Type: application/json
```

**请求体：**
```json
{
  "baseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1",
  "apiKey": "sk-xxx",
  "model": "qwen-plus",
  "prompt": "请为我规划一次日本5日游"
}
```

**响应体（成功）：**
```json
{
  "content": "## 日本5日游行程规划\n\n### 第一天：抵达东京..."
}
```

**响应体（失败）：**
```json
{
  "error": "请求处理失败：网络连接中断"
}
```

**功能特性：**
- 连接超时：10秒
- 读取超时：120秒
- 自动重试：最多3次，递增延迟
- 内容审查处理
- 错误分类处理

### 5.2 前端服务接口

#### 5.2.1 LLM服务
**文件：** `src/services/llm.js`

**主要函数：**
- `generatePlan(prompt)` - 生成旅行计划
- `analyzeBudget(budgetData)` - 分析预算

#### 5.2.2 地理编码服务
**文件：** `src/services/geocode.js`

**主要函数：**
- `geocode(address, signal)` - 地理编码
- `planRoute(points, strategy)` - 路线规划

#### 5.2.3 Supabase服务
**文件：** `src/services/supabase.js`

**主要函数：**
- `getSupabase()` - 获取Supabase客户端
- `saveSupabaseConfig(config)` - 保存配置
- `hasSupabaseConfig()` - 检查配置
- `shouldUseCloudStorage()` - 是否使用云端存储

#### 5.2.4 行程管理服务
**文件：** `src/services/plans.js`

**主要函数：**
- `savePlan(planData)` - 保存计划
- `getUserPlans()` - 获取用户所有计划
- `getPlan(planId)` - 获取单个计划
- `deletePlan(planId)` - 删除计划
- `saveUserProfile(userData)` - 保存用户资料
- `getUserProfile()` - 获取用户资料
- `saveUserPreferences(preferences)` - 保存偏好
- `getUserPreferences()` - 获取偏好
- `saveBudgetRecord(budgetData)` - 保存预算记录
- `getUserBudgetRecord()` - 获取预算记录

## 6. 外部服务集成

### 6.1 LLM服务集成

#### 6.1.1 支持的LLM服务
系统通过统一的OpenAI兼容接口支持多种LLM服务：

- **阿里云通义千问**
  - Base URL: `https://dashscope.aliyuncs.com/compatible-mode/v1`
  - 模型: `qwen-plus`, `qwen-turbo` 等

- **OpenAI**
  - Base URL: `https://api.openai.com/v1`
  - 模型: `gpt-4o-mini`, `gpt-4`, `gpt-3.5-turbo` 等

- **其他兼容OpenAI格式的服务**
  - 任何兼容OpenAI API格式的LLM服务

#### 6.1.2 集成方式
- 前端通过后端 `/api/llm/chat` 接口调用
- 后端作为代理，统一处理请求和响应
- 支持超时控制和自动重试
- 处理内容审查错误

#### 6.1.3 配置管理
- 配置存储在浏览器 `localStorage`
- 支持动态配置和导入导出
- 敏感信息（API Key）仅保存在客户端

### 6.2 地图服务集成

#### 6.2.1 高德地图
**集成方式：**
- 使用高德地图 JS API 2.0
- 动态加载SDK和插件
- 支持地理编码、路线规划等功能

**所需插件：**
- `AMap.Geocoder` - 地理编码
- `AMap.Driving` - 驾车路线
- `AMap.Walking` - 步行路线
- `AMap.Transit` - 公交路线

**API Key要求：**
- 必须使用"Web端（JS API）"类型的Key

#### 6.2.2 百度地图
**集成方式：**
- 使用百度地图 REST API
- 支持地理编码和路线规划

**API Key要求：**
- 需要申请百度地图API Key

#### 6.2.3 OpenStreetMap
**集成方式：**
- 使用 Nominatim 地理编码服务
- 无需API Key
- 注意频率限制（建议控制请求频率）

**特点：**
- 全球覆盖
- 免费使用
- 适合演示和开发

### 6.3 Supabase集成

#### 6.3.1 功能
- 用户认证（邮箱/密码）
- 数据存储（PostgreSQL）
- 实时数据同步
- Row Level Security (RLS) 支持

#### 6.3.2 集成方式
- 使用 Supabase JS SDK
- 支持本地模拟模式（未配置时）
- 自动切换云端/本地模式

#### 6.3.3 数据表创建
需要在Supabase控制台手动创建以下表：
- `travel_plans`
- `user_profiles`
- `user_preferences`
- `budget_records`

#### 6.3.4 安全策略
建议配置RLS策略：
- 用户只能访问自己的数据
- 基于 `user_id` 进行数据隔离

## 7. 部署方案

### 7.1 Docker部署

#### 7.1.1 前端部署
**Dockerfile：**
```dockerfile
# 构建阶段
FROM node:20-alpine AS builder
WORKDIR /app
COPY package.json package-lock.json* ./
RUN npm ci
COPY . .
RUN npm run build

# 服务阶段
FROM nginx:1.27-alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 7.1.2 后端部署
**Dockerfile：** `backend-java/Dockerfile`
- 基于Java 17镜像
- Maven构建
- Spring Boot运行

#### 7.1.3 Docker Compose
**docker-compose.yml：**
```yaml
services:
  backend:
    build:
      context: ./backend-java
      dockerfile: Dockerfile
    container_name: ai-travel-backend
    ports:
      - "8081:8080"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-travel-frontend
    depends_on:
      - backend
    ports:
      - "8080:80"
```

### 7.2 Nginx配置

#### 7.2.1 反向代理
`nginx.conf` 配置：
- 静态文件服务（前端）
- `/api` 路径代理到后端
- 同源策略，避免CORS问题

### 7.3 环境变量
**构建时环境变量：**
- `VITE_BACKEND_URL` - 后端地址
- `VITE_SUPABASE_URL` - Supabase地址

**运行时配置：**
- 通过 `./public/ai-travel-planner-config.json` 配置
- 或在Settings页面动态配置

### 7.4 部署步骤

1. **准备配置**
   ```bash
   # 编辑配置文件
   vim public/ai-travel-planner-config.json
   ```

2. **构建和启动**
   ```bash
   docker-compose up --build -d
   ```

3. **查看日志**
   ```bash
   docker-compose logs -f
   ```

4. **访问应用**
   - 前端：http://localhost:8080
   - 后端：http://localhost:8081

## 8. 安全设计

### 8.1 数据安全
- API Key等敏感信息仅存储在客户端
- 不提交到代码仓库
- 使用HTTPS传输（生产环境）

### 8.2 用户认证
- Supabase提供安全的用户认证
- JWT Token管理
- 会话自动刷新

### 8.3 数据隔离
- 基于 `user_id` 的数据隔离
- Supabase RLS策略
- 前端数据过滤

### 8.4 API安全
- 后端代理LLM请求，隐藏API Key
- 请求超时和重试控制
- 错误信息不暴露敏感数据

## 9. 性能优化

### 9.1 前端优化
- Vite构建优化
- 代码分割和懒加载
- 地图SDK动态加载
- 本地缓存策略

### 9.2 后端优化
- 连接池管理
- 请求超时控制
- 自动重试机制
- 错误处理优化

### 9.3 数据优化
- 本地存储缓存
- 云端数据分页
- 地图快照缓存
- 草稿自动保存

## 10. 扩展性设计

### 10.1 LLM服务扩展
- 统一的OpenAI兼容接口
- 易于添加新的LLM服务商
- 支持模型切换

### 10.2 地图服务扩展
- 插件化地图服务
- 统一的地理编码接口
- 易于添加新的地图服务商

### 10.3 功能扩展
- 模块化设计
- 服务层抽象
- 易于添加新功能

## 11. 测试策略

### 11.1 单元测试
- 服务层函数测试
- 工具函数测试

### 11.2 集成测试
- API接口测试
- 数据同步测试

### 11.3 端到端测试
- 用户流程测试
- 跨浏览器测试

## 12. 维护和监控

### 12.1 日志管理
- 前端控制台日志
- 后端应用日志
- Docker容器日志

### 12.2 错误监控
- 前端错误捕获
- 后端异常处理
- 用户反馈机制

### 12.3 性能监控
- API响应时间
- 页面加载时间
- 资源使用情况

## 13. 未来规划

### 13.1 功能增强
- 多语言支持
- 移动端适配
- 离线模式增强
- 社交分享功能

### 13.2 技术优化
- 服务端渲染（SSR）
- GraphQL API
- 微服务架构
- 实时协作功能

### 13.3 智能化提升
- 更精准的偏好识别
- 个性化推荐
- 智能预算优化
- 实时天气和交通信息

---

**文档版本：** v1.0  
**最后更新：** 2025年11月

